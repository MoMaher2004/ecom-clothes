<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Test Order & Payment Status</title>
</head>
<body>
  <h2>Test Create Order & Paymob Payment</h2>

  <label>Token:</label>
  <input type="text" id="token" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTAsImVtYWlsIjoiZW1tYS5qb2huc29uQGV4YW1wbGUuY29tIiwiYXV0aFR5cGUiOiJwYXNzd29yZCIsImlhdCI6MTc1NjA2MzAwNSwiZXhwIjoxNzU2MDkxODA1fQ.WpPhyR_xNxX4YBuXeHnpE-cJH_9tT3-A85uV4US7DI4" /><br><br>
  <form id="orderForm">

    <label>Government:</label>
    <input type="text" name="government" value="Cairo" /><br><br>

    <label>City:</label>
    <input type="text" name="city" value="Nasr City" /><br><br>

    <label>Address:</label>
    <input type="text" name="address" value="123 Street" /><br><br>

    <label>Phone Number:</label>
    <input type="text" name="phoneNumber" value="01000000000" /><br><br>

    <label>Second Phone Number:</label>
    <input type="text" name="secondPhoneNumber" value="01011111111" /><br><br>

    <label>Notes:</label>
    <input type="text" name="notes" value="Test order" /><br><br>

    <label>Zip Code:</label>
    <input type="text" name="zipCode" value="11511" /><br><br>

    <button type="submit">Create Order & Pay</button>
  </form>

  <div id="paymentIframe" style="margin-top:20px;"></div>
  <div id="paymentStatus" style="margin-top:20px; font-weight:bold;"></div>

  <script>
    const form = document.getElementById('orderForm');
    const iframeDiv = document.getElementById('paymentIframe');
    const statusDiv = document.getElementById('paymentStatus');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      const token = document.getElementById('token').value
      try {
        // 1️⃣ Create order
        const orderRes = await fetch('http://127.0.0.1:3000/api/order/makeOrder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json',
             'Authorization': `Bearer ${token}`
           },
          body: JSON.stringify(data)
        });
        const orderData = await orderRes.json();
        if (orderData.error) {
          alert('Error creating order: ' + orderData.error);
          return;
        }

  
        alert('Order created successfully! Now generating payment...');
        console.log(orderData)
        

        if (orderData.error) {
          alert('Payment error: ' + orderData.error);
          return;
        }

        iframeDiv.innerHTML = `<iframe src="${orderData.iframeURL}" width="500" height="600"></iframe>`;

        // Periodically check payment status
        const interval = setInterval(async () => {
          const statusRes = await fetch(`http://127.0.0.1:3000/api/order/checkPaymentStatus/${orderData.orderId}`);
          const statusData = await statusRes.json();

          if (statusData.success) {
            statusDiv.innerText = '✅ Payment Successful!';
            clearInterval(interval);
          } else if (statusData.failed) {
            statusDiv.innerText = '❌ Payment Failed!';
            clearInterval(interval);
          } else {
            statusDiv.innerText = '⏳ Payment Pending...';
          }
        }, 5000); // check every 5 seconds

      } catch (err) {
        console.error(err);
        alert('Something went wrong');
      }
    });
  </script>
</body>
</html>
